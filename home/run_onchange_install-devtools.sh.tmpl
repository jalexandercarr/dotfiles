#!/bin/bash
# chezmoi:template:left-delimiter="{{" right-delimiter="}}"
# Install development tools - optional, controlled by chezmoi config
# Uses system package managers which handle updates in-place automatically

# Source the logging helper (installed by chezmoi before scripts run)
source "${HOME}/.local/bin/chezmoi-log-helper.sh" 2>/dev/null || {
    mkdir -p "${HOME}/.local/log/chezmoi"
    CHEZMOI_LOG_FILE="${HOME}/.local/log/chezmoi/install-$(date +%Y%m%d-%H%M%S).log"
    print_header() { printf "\n\033[1;34m▸\033[0m \033[1m%s\033[0m\n" "$1"; }
    print_done() { printf "  \033[32m✓\033[0m %s\n" "$1"; }
    print_fail() { printf "  \033[31m✗\033[0m %s\n" "$1"; }
    with_spinner() { shift; "$@" >> "$CHEZMOI_LOG_FILE" 2>&1; }
    log_silent() { :; }; log_section() { :; }
}

{{- if not .packages.devtools }}
exit 0
{{- end }}

set -euo pipefail

OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
ARCH="$(uname -m)"

log_section "Development Tools Installation"
print_header "Development Tools"

install_devtools_macos() {
    if ! command -v brew >/dev/null; then
        with_spinner "Installing Homebrew" /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
    with_spinner "Installing dev packages" brew install --quiet git gnu-tar gnu-sed bash-completion pkg-config openssh
}

install_devtools_debian() {
    with_spinner "Updating package lists" sudo apt-get update -qq
    with_spinner "Installing dev packages" sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq build-essential libssl-dev make git g++ curl bash-completion pkg-config openssh-client fuse libfuse2 software-properties-common
}

install_devtools_fedora() {
    with_spinner "Installing dev packages" sudo dnf install -y -q @development-tools openssl-devel make git gcc-c++ curl bash-completion pkgconf-pkg-config openssh-clients
}

install_devtools_rhel() {
    with_spinner "Installing Development Tools group" sudo yum groupinstall -y -q "Development Tools"
    with_spinner "Installing additional packages" sudo yum install -y -q openssl-devel make git gcc-c++ curl bash-completion pkgconfig openssh-clients
}

install_devtools_arch() {
    with_spinner "Installing dev packages" sudo pacman -Sy --noconfirm --quiet base-devel openssl make git gcc curl bash-completion pkgconf openssh
}

if [[ "$OS" == "darwin" ]]; then
    install_devtools_macos
elif [[ -f /etc/debian_version ]]; then
    install_devtools_debian
elif [[ -f /etc/fedora-release ]]; then
    install_devtools_fedora
elif [[ -f /etc/centos-release ]] || [[ -f /etc/redhat-release ]] || [[ -f /etc/system-release ]]; then
    install_devtools_rhel
elif [[ -f /etc/arch-release ]]; then
    install_devtools_arch
else
    print_fail "Unsupported OS for devtools installation"
    log_silent "Unsupported OS: $OS"
    exit 1
fi

print_done "Development tools installed"
