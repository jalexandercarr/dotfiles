#!/bin/bash
# chezmoi:template:left-delimiter="{{" right-delimiter="}}"
# Install Python via pyenv - optional, controlled by chezmoi config
# pyenv provides idempotent version management - updates in place, no uninstall needed

# Source the logging helper (installed by chezmoi before scripts run)
source "${HOME}/.local/bin/chezmoi-log-helper.sh" 2>/dev/null || {
    mkdir -p "${HOME}/.local/log/chezmoi"
    CHEZMOI_LOG_FILE="${HOME}/.local/log/chezmoi/install-$(date +%Y%m%d-%H%M%S).log"
    print_header() { printf "\n\033[1;34m▸\033[0m \033[1m%s\033[0m\n" "$1"; }
    print_done() { printf "  \033[32m✓\033[0m %s\n" "$1"; }
    print_skip() { printf "  \033[2m○ %s\033[0m\n" "$1"; }
    print_fail() { printf "  \033[31m✗\033[0m %s\n" "$1"; }
    with_spinner() { shift; "$@" >> "$CHEZMOI_LOG_FILE" 2>&1; }
    log_silent() { :; }; log_section() { :; }
}

{{- if not .packages.python }}
print_skip "Python (disabled in config)"
exit 0
{{- end }}

set -euo pipefail

OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
ARCH="$(uname -m)"

PYTHON_VERSION="3.14.3"
PYENV_ROOT="${HOME}/.pyenv"

log_section "Python Installation"
print_header "Python ${PYTHON_VERSION}"

# Install build dependencies based on OS
install_pyenv_deps() {
    if [[ "$OS" == "darwin" ]]; then
        if ! command -v brew >/dev/null; then
            with_spinner "Installing Homebrew" /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        with_spinner "Installing build dependencies" brew install --quiet openssl readline sqlite3 xz zlib tcl-tk git
    elif [[ -f /etc/debian_version ]]; then
        export DEBIAN_FRONTEND=noninteractive
        with_spinner "Updating package lists" sudo apt-get update -qq
        with_spinner "Installing build dependencies" sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev curl git libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev
    elif [[ -f /etc/fedora-release ]]; then
        with_spinner "Installing build dependencies" sudo dnf install -y -q make gcc patch zlib-devel bzip2 bzip2-devel \
            readline-devel sqlite sqlite-devel openssl-devel tk-devel libffi-devel xz-devel git curl
    elif [[ -f /etc/centos-release ]] || [[ -f /etc/redhat-release ]] || [[ -f /etc/system-release ]]; then
        with_spinner "Installing Development Tools" sudo yum groupinstall -y -q "Development Tools"
        # Check if this is Amazon Linux 2 (needs openssl11-devel for modern Python)
        if grep -q "Amazon Linux 2" /etc/system-release 2>/dev/null; then
            with_spinner "Installing build dependencies" sudo yum install -y -q zlib-devel bzip2 bzip2-devel \
                readline-devel sqlite sqlite-devel openssl11-devel xz xz-devel libffi-devel \
                ncurses-devel patch tk-devel git curl
        else
            with_spinner "Installing build dependencies" sudo yum install -y -q zlib-devel bzip2 bzip2-devel \
                readline-devel sqlite sqlite-devel openssl-devel xz xz-devel libffi-devel \
                ncurses-devel patch tk-devel git curl
        fi
    elif [[ -f /etc/arch-release ]]; then
        with_spinner "Installing build dependencies" sudo pacman -Sy --noconfirm --quiet base-devel openssl zlib \
            xz tk git curl
    else
        print_fail "Unsupported OS for Python installation"
        exit 1
    fi
}

# Enable git HTTPS override for installation
enable_git_https_override 2>/dev/null || true

install_pyenv_deps

# Configure OpenSSL 1.1 paths for Amazon Linux 2 (pyenv needs these for compilation)
if grep -q "Amazon Linux 2" /etc/system-release 2>/dev/null; then
    export CFLAGS="-I/usr/include/openssl11"
    export LDFLAGS="-L/usr/lib64/openssl11"
fi

# Install or update pyenv (idempotent - updates in place)
if [[ -d "$PYENV_ROOT" ]]; then
    with_spinner "Updating pyenv" bash -c "cd $PYENV_ROOT && git pull --quiet origin master"
    # Also update pyenv-virtualenv if installed
    if [[ -d "$PYENV_ROOT/plugins/pyenv-virtualenv" ]]; then
        log_silent "Updating pyenv-virtualenv"
        (cd "$PYENV_ROOT/plugins/pyenv-virtualenv" && git pull --quiet origin master) >> "$CHEZMOI_LOG_FILE" 2>&1 || true
    fi
else
    with_spinner "Installing pyenv" git clone --quiet https://github.com/pyenv/pyenv.git "$PYENV_ROOT"
    # Install pyenv-virtualenv plugin
    with_spinner "Installing pyenv-virtualenv" git clone --quiet https://github.com/pyenv/pyenv-virtualenv.git "$PYENV_ROOT/plugins/pyenv-virtualenv"
fi

# Set up pyenv environment for this script
export PYENV_ROOT
export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init -)" >> "$CHEZMOI_LOG_FILE" 2>&1 || true

# Install the specified Python version (pyenv handles this idempotently)
if pyenv versions --bare 2>/dev/null | grep -q "^${PYTHON_VERSION}$"; then
    print_skip "Python ${PYTHON_VERSION} already installed"
else
    with_spinner "Installing python ${PYTHON_VERSION}" pyenv install "$PYTHON_VERSION"
fi

# Set global version
with_spinner "Setting python ${PYTHON_VERSION} as global" pyenv global "$PYTHON_VERSION"
# Clean up old Python versions (keep only the current version)
log_silent "Cleaning up old Python versions"
for version in $(pyenv versions --bare 2>/dev/null | grep -v '/'); do
    if [[ "$version" != "$PYTHON_VERSION" ]]; then
        log_silent "Removing old Python version: $version"
        pyenv uninstall -f "$version" >> "$CHEZMOI_LOG_FILE" 2>&1 || true
    fi
done

print_done "Python ${PYTHON_VERSION} installed"
