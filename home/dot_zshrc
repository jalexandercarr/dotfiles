# ~/.zshrc - executed by zsh(1) for interactive shells

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

# --- History ---
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_IGNORE_SPACE
setopt APPEND_HISTORY
setopt INC_APPEND_HISTORY

HISTFILE="$HOME/.zsh_history"
HISTSIZE=1000
SAVEHIST=2000

# --- Lesspipe ---
[[ -x /usr/bin/lesspipe ]] && eval "$(SHELL=/bin/sh lesspipe)"

# --- Chroot detection ---
if [[ -z "$debian_chroot" && -r /etc/debian_chroot ]]; then
    debian_chroot=$(cat /etc/debian_chroot 2>/dev/null)
fi

# --- GIT branch helper ---
git_branch() {
  local branch
  if command -v git &>/dev/null && git rev-parse --is-inside-work-tree &>/dev/null; then
    branch=$(git symbolic-ref --short HEAD 2>/dev/null || git describe --tags --exact-match 2>/dev/null)
    if [[ -n $branch ]]; then
      echo " ${branch} "
    fi
  fi
}

# --- Kubernetes context and namespace helper ---
kube_info() {
  if command -v kubectl &>/dev/null; then
    local kube
    kube=$(kubectl config view --minify --output 'jsonpath={.current-context}:{..namespace}' 2>/dev/null)
    if [[ -n $kube ]]; then
      echo "ó° ³ ${kube} "
    fi
  fi
}

# --- Prompt timing ---
timer_start() {
  start_time=$(date +%s%N)
}

timer_stop() {
  end_time=$(date +%s%N)
  if [[ "$start_time" == "0" || -z "$start_time" ]]; then
    timer_show=0
  else
    timer_show=$(((end_time - start_time) / 1000000))
  fi
}

# --- Custom prompt ---
setopt PROMPT_SUBST

# Dynamically set PROMPT with printf to right-justify the time
function set_zsh_prompt() {
  local left right prompt_line
  left="%F{yellow}$(git_branch)%f%F{blue}$(kube_info)%f%F{green}%n@%m%f%F{white}:%f%F{magenta}%~%f %F{white}${timer_show}ms%f"
  right="%F{white}%D{%r}%f"
  # Remove color codes for width calculation
  local left_plain=$(print -P "$left" | sed 's/\x1b\[[0-9;]*m//g')
  local right_plain=$(print -P "$right" | sed 's/\x1b\[[0-9;]*m//g')
  local width=$COLUMNS
  local left_len=${#left_plain}
  local right_len=${#right_plain}
  local space_count=$(( width - left_len - right_len ))
  (( space_count < 1 )) && space_count=1
  local spaces=""
  for ((i=0; i<space_count; i++)); do spaces+=" "; done
  prompt_line="$left$spaces$right"
  PROMPT="$(printf '%s\n%%F{white}$%%f ' "$prompt_line")"
}

preexec() {
  timer_start
}

precmd() {
  timer_stop
  set_zsh_prompt
}

# --- Tool initialization ---
if command -v goenv &>/dev/null; then
    eval "$(goenv init -)" 2>/dev/null
fi

if command -v pyenv &>/dev/null; then
    eval "$(pyenv init -)" 2>/dev/null
    eval "$(pyenv virtualenv-init -)" 2>/dev/null
fi

# --- Aliases ---
if [[ -f ~/.aliases ]]; then
    source ~/.aliases
fi

# --- Completions ---
if [[ -f ~/.zsh_completion ]]; then
    source ~/.zsh_completion
fi
