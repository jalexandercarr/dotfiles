#!/bin/bash
# chezmoi:template:left-delimiter="{{" right-delimiter="}}"
# Install Kubernetes tools - optional, controlled by chezmoi config

# Initialize log file first (before any redirects)
mkdir -p "${HOME}/.local/log/chezmoi"
CHEZMOI_LOG_FILE="${HOME}/.local/log/chezmoi/install-$(date +%Y%m%d-%H%M%S).log"

# Source the logging helper
HELPER_SCRIPT="${HOME}/.local/bin/chezmoi-log-helper.sh"
if [[ -f "$HELPER_SCRIPT" ]]; then
    source "$HELPER_SCRIPT"
else
    # Fallback if helper not yet installed - create minimal functions
    print_header() { printf "\n\033[1m\033[34m▸\033[0m \033[1m%s\033[0m\n" "$1"; }
    print_done() { printf "  \033[32m✓\033[0m %s\n" "$1"; }
    print_skip() { printf "  \033[2m○\033[0m \033[2m%s\033[0m\n" "$1"; }
    print_fail() { printf "  \033[31m✗\033[0m %s\n" "$1"; }
    with_spinner() { local msg="$1"; shift; printf "  \033[36m⠋\033[0m %s" "$msg"; if "$@" >> "$CHEZMOI_LOG_FILE" 2>&1; then printf "\r\033[K"; print_done "$msg"; else printf "\r\033[K"; print_fail "$msg"; return 1; fi; }
    log_silent() { echo "[$(date '+%H:%M:%S')] $*" >> "$CHEZMOI_LOG_FILE"; }
    log_section() { echo "=== $1 ===" >> "$CHEZMOI_LOG_FILE"; }
fi

{{- if not .packages.kubernetes }}
print_skip "Kubernetes tools (disabled in config)"
exit 0
{{- end }}

set -euo pipefail

OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
ARCH="$(uname -m)"

# Normalize architecture
ARCH_STD="$ARCH"
if [[ "$ARCH_STD" == "x86_64" || "$ARCH_STD" == "amd64" ]]; then
    ARCH_STD="amd64"
elif [[ "$ARCH_STD" == "arm64" || "$ARCH_STD" == "aarch64" ]]; then
    ARCH_STD="arm64"
else
    print_fail "Unsupported architecture: $ARCH_STD"
    exit 1
fi

log_section "Kubernetes Tools Installation"
print_header "Kubernetes Tools"

# Override git to use HTTPS during installation
git() {
    GIT_CONFIG_NOSYSTEM=1 \
    GIT_CONFIG_GLOBAL=/dev/null \
    command git \
      -c url."https://github.com/".insteadof=ssh://github.com/ \
      -c url."https://github.com/".insteadof=ssh://git@github.com/ \
      -c url."https://github.com/".insteadof=git@github.com: \
      -c url."https://github.com/".insteadof=git://github.com/ \
      "$@"
}
export -f git

install_k8s_macos() {
    if ! command -v brew >/dev/null; then
        with_spinner "Installing Homebrew" /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
    with_spinner "Installing kind" brew install --quiet kind
    with_spinner "Installing kubectl" brew install --quiet kubectl
    with_spinner "Installing kubectx/kubens" brew install --quiet kubectx
}

install_k8s_linux() {
    # Install kind
    log_silent "Downloading kind"
    curl -fsSL -o /tmp/kind "https://kind.sigs.k8s.io/dl/latest/kind-linux-$ARCH_STD" >> "$CHEZMOI_LOG_FILE" 2>&1
    chmod +x /tmp/kind >> "$CHEZMOI_LOG_FILE" 2>&1
    with_spinner "Installing kind" sudo mv /tmp/kind /usr/local/bin/kind

    # Install kubectl
    log_silent "Getting kubectl version"
    KUBECTL_VERSION="$(curl -fsSL https://dl.k8s.io/release/stable.txt 2>> "$CHEZMOI_LOG_FILE")"
    log_silent "Downloading kubectl ${KUBECTL_VERSION}"
    curl -fsSL -o /tmp/kubectl "https://dl.k8s.io/release/$KUBECTL_VERSION/bin/linux/$ARCH_STD/kubectl" >> "$CHEZMOI_LOG_FILE" 2>&1
    with_spinner "Installing kubectl" sudo install -o root -g root -m 0755 /tmp/kubectl /usr/local/bin/kubectl
    
    # Setup kubectl completion
    log_silent "Setting up kubectl completion"
    sudo /usr/local/bin/kubectl completion bash 2>/dev/null | sudo tee /etc/bash_completion.d/kubectl > /dev/null 2>> "$CHEZMOI_LOG_FILE"
    rm -f /tmp/kubectl >> "$CHEZMOI_LOG_FILE" 2>&1

    # Install kubectx and kubens
    log_silent "Installing kubectx and kubens"
    sudo rm -rf /opt/kubectx >> "$CHEZMOI_LOG_FILE" 2>&1 || true
    sudo rm -f /usr/local/bin/kubectx /usr/local/bin/kubens >> "$CHEZMOI_LOG_FILE" 2>&1 || true
    with_spinner "Installing kubectx/kubens" sudo git clone --quiet https://github.com/ahmetb/kubectx.git /opt/kubectx
    
    # Create symlinks
    log_silent "Creating kubectx/kubens symlinks"
    sudo ln -sf /opt/kubectx/kubectx /usr/local/bin/kubectx >> "$CHEZMOI_LOG_FILE" 2>&1
    sudo ln -sf /opt/kubectx/kubens /usr/local/bin/kubens >> "$CHEZMOI_LOG_FILE" 2>&1
    sudo ln -sf /opt/kubectx/completion/kubectx.bash /etc/bash_completion.d/kubectx 2>/dev/null || true
    sudo ln -sf /opt/kubectx/completion/kubens.bash /etc/bash_completion.d/kubens 2>/dev/null || true
}

if [[ "$OS" == "darwin" ]]; then
    install_k8s_macos
else
    install_k8s_linux
fi

print_done "Kubernetes tools installed"
