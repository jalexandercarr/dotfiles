#!/bin/bash
# chezmoi:template:left-delimiter="{{" right-delimiter="}}"
# Install Kubernetes tools - optional, controlled by chezmoi config
# Binaries are downloaded fresh each run, replacing any existing versions in-place

# Source the logging helper (installed by chezmoi before scripts run)
source "${HOME}/.local/bin/chezmoi-log-helper.sh" 2>/dev/null || {
    mkdir -p "${HOME}/.local/log/chezmoi"
    CHEZMOI_LOG_FILE="${HOME}/.local/log/chezmoi/install-$(date +%Y%m%d-%H%M%S).log"
    print_header() { printf "\n\033[1;34m▸\033[0m \033[1m%s\033[0m\n" "$1"; }
    print_done() { printf "  \033[32m✓\033[0m %s\n" "$1"; }
    print_skip() { printf "  \033[2m○ %s\033[0m\n" "$1"; }
    print_fail() { printf "  \033[31m✗\033[0m %s\n" "$1"; }
    with_spinner() { shift; "$@" >> "$CHEZMOI_LOG_FILE" 2>&1; }
    log_silent() { :; }; log_section() { :; }
}

{{- if not .packages.kubernetes }}
print_skip "Kubernetes tools (disabled in config)"
exit 0
{{- end }}

set -euo pipefail

OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
ARCH="$(uname -m)"

KIND_VERSION="0.31.0"
KUBECTL_VERSION="1.35.0"

# Normalize architecture
ARCH_STD="$ARCH"
if [[ "$ARCH_STD" == "x86_64" || "$ARCH_STD" == "amd64" ]]; then
    ARCH_STD="amd64"
elif [[ "$ARCH_STD" == "arm64" || "$ARCH_STD" == "aarch64" ]]; then
    ARCH_STD="arm64"
else
    print_fail "Unsupported architecture: $ARCH_STD"
    exit 1
fi

log_section "Kubernetes Tools Installation"
print_header "Kubernetes Tools"

# Enable git HTTPS override for installation
enable_git_https_override 2>/dev/null || true

install_k8s_macos() {
    if ! command -v brew >/dev/null; then
        with_spinner "Installing Homebrew" /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
    with_spinner "Installing kind" brew install --quiet kind
    with_spinner "Installing kubectl" brew install --quiet kubectl
    with_spinner "Installing kubectx/kubens" brew install --quiet kubectx
}

install_k8s_linux() {
    # Clean up and install kind (in-place update)
    log_silent "Removing old kind binary if present"
    sudo rm -f /usr/local/bin/kind >> "$CHEZMOI_LOG_FILE" 2>&1 || true
    
    log_silent "Downloading kind ${KIND_VERSION}"
    curl -fsSL -o /tmp/kind "https://kind.sigs.k8s.io/dl/v${KIND_VERSION}/kind-linux-$ARCH_STD" >> "$CHEZMOI_LOG_FILE" 2>&1
    chmod +x /tmp/kind >> "$CHEZMOI_LOG_FILE" 2>&1
    with_spinner "Installing kind ${KIND_VERSION}" sudo mv /tmp/kind /usr/local/bin/kind

    # Clean up and install kubectl (in-place update)
    log_silent "Removing old kubectl binary if present"
    sudo rm -f /usr/local/bin/kubectl >> "$CHEZMOI_LOG_FILE" 2>&1 || true
    
    log_silent "Downloading kubectl ${KUBECTL_VERSION}"
    curl -fsSL -o /tmp/kubectl "https://dl.k8s.io/release/v${KUBECTL_VERSION}/bin/linux/$ARCH_STD/kubectl" >> "$CHEZMOI_LOG_FILE" 2>&1
    with_spinner "Installing kubectl ${KUBECTL_VERSION}" sudo install -o root -g root -m 0755 /tmp/kubectl /usr/local/bin/kubectl
    
    # Setup kubectl completion
    log_silent "Setting up kubectl completion"
    sudo /usr/local/bin/kubectl completion bash 2>/dev/null | sudo tee /etc/bash_completion.d/kubectl > /dev/null 2>> "$CHEZMOI_LOG_FILE"
    rm -f /tmp/kubectl >> "$CHEZMOI_LOG_FILE" 2>&1

    # Clean up and install kubectx and kubens (in-place update via git)
    log_silent "Cleaning up old kubectx installation"
    sudo rm -rf /opt/kubectx >> "$CHEZMOI_LOG_FILE" 2>&1 || true
    sudo rm -f /usr/local/bin/kubectx /usr/local/bin/kubens >> "$CHEZMOI_LOG_FILE" 2>&1 || true
    with_spinner "Installing kubectx/kubens" sudo git clone --quiet https://github.com/ahmetb/kubectx.git /opt/kubectx
    
    # Create symlinks
    log_silent "Creating kubectx/kubens symlinks"
    sudo ln -sf /opt/kubectx/kubectx /usr/local/bin/kubectx >> "$CHEZMOI_LOG_FILE" 2>&1
    sudo ln -sf /opt/kubectx/kubens /usr/local/bin/kubens >> "$CHEZMOI_LOG_FILE" 2>&1
    sudo ln -sf /opt/kubectx/completion/kubectx.bash /etc/bash_completion.d/kubectx 2>/dev/null || true
    sudo ln -sf /opt/kubectx/completion/kubens.bash /etc/bash_completion.d/kubens 2>/dev/null || true
}

if [[ "$OS" == "darwin" ]]; then
    install_k8s_macos
else
    install_k8s_linux
fi

print_done "Kubernetes tools installed"
