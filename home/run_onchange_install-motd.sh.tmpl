#!/bin/bash
# Updates /etc/motd with system information

{{ if not .addons.motd -}}
print_skip "MOTD (disabled in config)"
exit 0
{{ end -}}

# Initialize log file first (before any redirects)
mkdir -p "${HOME}/.local/log/chezmoi"
CHEZMOI_LOG_FILE="${HOME}/.local/log/chezmoi/install-$(date +%Y%m%d-%H%M%S).log"

# Source the logging helper
HELPER_SCRIPT="${HOME}/.local/bin/chezmoi-log-helper.sh"
if [[ -f "$HELPER_SCRIPT" ]]; then
    source "$HELPER_SCRIPT"
else
    # Fallback if helper not yet installed - create minimal functions
    print_header() { printf "\n\033[1m\033[34m▸\033[0m \033[1m%s\033[0m\n" "$1"; }
    print_done() { printf "  \033[32m✓\033[0m %s\n" "$1"; }
    print_skip() { printf "  \033[2m○\033[0m \033[2m%s\033[0m\n" "$1"; }
    print_fail() { printf "  \033[31m✗\033[0m %s\n" "$1"; }
    log_silent() { echo "[$(date '+%H:%M:%S')] $*" >> "$CHEZMOI_LOG_FILE"; }
    log_section() { echo "=== $1 ===" >> "$CHEZMOI_LOG_FILE"; }
fi

set -euo pipefail

log_section "MOTD Installation"
print_header "MOTD Configuration"

# Colors and formatting
BOLD='\033[1m'
DIM='\033[2m'
CYAN='\033[36m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
MAGENTA='\033[35m'
WHITE='\033[97m'
RESET='\033[0m'

# Generate MOTD content
generate_motd() {
    local os_name arch hostname_str user_name
    local mem_total mem_used mem_percent
    local disk_total disk_used disk_percent
    local ip_addr uptime_str
    local updates_info active_users

    # Detect OS
    if [[ -f /etc/os-release ]]; then
        os_name=$(source /etc/os-release && echo "$PRETTY_NAME")
    elif [[ "$(uname)" == "Darwin" ]]; then
        os_name="macOS $(sw_vers -productVersion)"
    else
        os_name=$(uname -s)
    fi

    # System info
    arch=$(uname -m)
    hostname_str=$(hostname -s 2>/dev/null || hostname)
    user_name=$(whoami)

    # Memory info
    if [[ "$(uname)" == "Darwin" ]]; then
        mem_total=$(sysctl -n hw.memsize | awk '{printf "%.1f GB", $1/1024/1024/1024}')
        # macOS memory usage approximation
        pages_free=$(vm_stat | grep "Pages free" | awk '{print $3}' | tr -d '.')
        pages_active=$(vm_stat | grep "Pages active" | awk '{print $3}' | tr -d '.')
        pages_inactive=$(vm_stat | grep "Pages inactive" | awk '{print $3}' | tr -d '.')
        pages_wired=$(vm_stat | grep "Pages wired" | awk '{print $4}' | tr -d '.')
        page_size=$(sysctl -n hw.pagesize)
        mem_used_bytes=$(( (pages_active + pages_wired) * page_size ))
        mem_total_bytes=$(sysctl -n hw.memsize)
        mem_percent=$(awk "BEGIN {printf \"%.0f\", ($mem_used_bytes/$mem_total_bytes)*100}")
        mem_used=$(awk "BEGIN {printf \"%.1f GB\", $mem_used_bytes/1024/1024/1024}")
    else
        mem_info=$(free -b | grep Mem)
        mem_total_bytes=$(echo "$mem_info" | awk '{print $2}')
        mem_used_bytes=$(echo "$mem_info" | awk '{print $3}')
        mem_total=$(awk "BEGIN {printf \"%.1f GB\", $mem_total_bytes/1024/1024/1024}")
        mem_used=$(awk "BEGIN {printf \"%.1f GB\", $mem_used_bytes/1024/1024/1024}")
        mem_percent=$(awk "BEGIN {printf \"%.0f\", ($mem_used_bytes/$mem_total_bytes)*100}")
    fi

    # Disk info (root filesystem)
    if [[ "$(uname)" == "Darwin" ]]; then
        disk_info=$(df -H / | tail -1)
    else
        disk_info=$(df -H / | tail -1)
    fi
    disk_total=$(echo "$disk_info" | awk '{print $2}')
    disk_used=$(echo "$disk_info" | awk '{print $3}')
    disk_percent=$(echo "$disk_info" | awk '{print $5}' | tr -d '%')

    # IP address
    if [[ "$(uname)" == "Darwin" ]]; then
        ip_addr=$(ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null || echo "N/A")
    else
        ip_addr=$(hostname -I 2>/dev/null | awk '{print $1}' || ip route get 1 2>/dev/null | awk '{print $7;exit}' || echo "N/A")
    fi

    # Uptime
    if [[ "$(uname)" == "Darwin" ]]; then
        boot_time=$(sysctl -n kern.boottime | awk -F'[= ,]' '{print $6}')
        now=$(date +%s)
        uptime_secs=$((now - boot_time))
        uptime_days=$((uptime_secs / 86400))
        uptime_hours=$(( (uptime_secs % 86400) / 3600 ))
        uptime_mins=$(( (uptime_secs % 3600) / 60 ))
        uptime_str="${uptime_days}d ${uptime_hours}h ${uptime_mins}m"
    else
        uptime_str=$(uptime -p 2>/dev/null | sed 's/up //' || uptime | awk -F'( |,|:)+' '{print $6" days, "$8"h "$9"m"}')
    fi

    # Available updates
    if command -v apt &>/dev/null; then
        updates_info=$(apt list --upgradable 2>/dev/null | grep -c upgradable) || updates_info=0
        updates_info="${updates_info} packages"
    elif command -v dnf &>/dev/null; then
        updates_info=$(dnf check-update --quiet 2>/dev/null | wc -l | tr -d ' ')
        updates_info="${updates_info} packages"
    elif command -v yum &>/dev/null; then
        updates_info=$(yum check-update --quiet 2>/dev/null | wc -l | tr -d ' ')
        updates_info="${updates_info} packages"
    elif [[ "$(uname)" == "Darwin" ]]; then
        updates_info=$(softwareupdate -l 2>&1 | grep -c "Title:" || echo "0")
        updates_info="${updates_info} updates"
    else
        updates_info="N/A"
    fi

    # Active users/sessions
    # Detect if running in a container
    if [[ -f /.dockerenv ]] || grep -q 'docker\|lxc\|containerd' /proc/1/cgroup 2>/dev/null; then
        # In container: count PTY sessions (each -it session creates a /dev/pts/N)
        # Subtract 1 for ptmx
        active_users=$(find /dev/pts -maxdepth 1 -type c ! -name ptmx 2>/dev/null | wc -l | tr -d ' ')
        users_list="docker sessions"
    else
        # Normal system: use who
        active_users=$(who | wc -l | tr -d ' ')
        users_list=$(who | awk '{print $1}' | sort -u | tr '\n' ' ')
    fi

    # Chezmoi status
    if command -v chezmoi &>/dev/null; then
        chezmoi_changes=$(chezmoi status 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$chezmoi_changes" -gt 0 ]]; then
            chezmoi_status="${YELLOW}${chezmoi_changes} files need update${RESET} (run: chezmoi apply)"
        else
            chezmoi_status="${GREEN}✓ Up to date${RESET}"
        fi
    else
        chezmoi_status="${DIM}not installed${RESET}"
    fi

    # Build progress bar function
    progress_bar() {
        local percent=$1
        local width=20
        local filled=$((percent * width / 100))
        local empty=$((width - filled))
        local bar=""
        
        for ((i=0; i<filled; i++)); do bar+="█"; done
        for ((i=0; i<empty; i++)); do bar+="░"; done
        
        if [[ $percent -ge 90 ]]; then
            echo -e "${YELLOW}${bar}${RESET}"
        elif [[ $percent -ge 70 ]]; then
            echo -e "${CYAN}${bar}${RESET}"
        else
            echo -e "${GREEN}${bar}${RESET}"
        fi
    }

    # Fixed 68-character width box with centered text
    local box_width=68
    local max_text_len=$((box_width - 4))  # Account for ║ and spaces on each side
    local welcome_text="Welcome to ${hostname_str}"
    if [[ ${#welcome_text} -gt $max_text_len ]]; then
        welcome_text="${welcome_text:0:$((max_text_len - 3))}..."
    fi
    local text_len=${#welcome_text}
    local total_padding=$((box_width - 2 - text_len))  # -2 for the ║ on each side
    local left_pad=$((total_padding / 2))
    local right_pad=$((total_padding - left_pad))
    local left_spaces=$(printf '%*s' $left_pad '')
    local right_spaces=$(printf '%*s' $right_pad '')
    local border=""
    for ((i=0; i<box_width-2; i++)); do border+="═"; done

    # Generate the MOTD
    cat << EOF

${CYAN}╔${border}╗${RESET}
${CYAN}║${RESET}${left_spaces}${BOLD}${WHITE}${welcome_text}${RESET}${right_spaces}${CYAN}║${RESET}
${CYAN}╚${border}╝${RESET}

  ${BOLD}${BLUE}SYSTEM${RESET}
  ├─ ${DIM}OS${RESET}           ${os_name}
  ├─ ${DIM}User${RESET}         ${user_name}
  ├─ ${DIM}Arch${RESET}         ${arch}
  └─ ${DIM}Uptime${RESET}       ${uptime_str}

  ${BOLD}${MAGENTA}RESOURCES${RESET}
  ├─ ${DIM}Memory${RESET}       ${mem_used} / ${mem_total} (${mem_percent}%)
  │              $(progress_bar ${mem_percent})
  ├─ ${DIM}Disk${RESET}         ${disk_used} / ${disk_total} (${disk_percent}%)
  │              $(progress_bar ${disk_percent})
  └─ ${DIM}IP Address${RESET}   ${ip_addr}

  ${BOLD}${GREEN}STATUS${RESET}
  ├─ ${DIM}Updates${RESET}      ${updates_info} available
  ├─ ${DIM}Chezmoi${RESET}      ${chezmoi_status}
  └─ ${DIM}Sessions${RESET}     ${active_users} active (${users_list})

${DIM}────────────────────────────────────────────────────────────────────────${RESET}
EOF
}

# Main execution
log_silent "Generating system MOTD"

# Generate MOTD to temp file
MOTD_CONTENT=$(generate_motd)

# Write to /etc/motd (requires sudo on most systems)
if [[ -w /etc/motd ]] || [[ "$(id -u)" == "0" ]]; then
    echo -e "$MOTD_CONTENT" > /etc/motd 2>> "$CHEZMOI_LOG_FILE"
    print_done "MOTD configured"
else
    echo -e "$MOTD_CONTENT" | sudo tee /etc/motd > /dev/null 2>> "$CHEZMOI_LOG_FILE"
    print_done "MOTD configured (with sudo)"
fi

log_silent "MOTD installation complete"
