#!/bin/bash
# chezmoi:template:left-delimiter="{{" right-delimiter="}}"
# Install Go via goenv - optional, controlled by chezmoi config
# goenv provides idempotent version management - updates in place, no uninstall needed

# Source the logging helper (installed by chezmoi before scripts run)
source "${HOME}/.local/bin/chezmoi-log-helper.sh" 2>/dev/null || {
    mkdir -p "${HOME}/.local/log/chezmoi"
    CHEZMOI_LOG_FILE="${HOME}/.local/log/chezmoi/install-$(date +%Y%m%d-%H%M%S).log"
    print_header() { printf "\n\033[1;34m▸\033[0m \033[1m%s\033[0m\n" "$1"; }
    print_done() { printf "  \033[32m✓\033[0m %s\n" "$1"; }
    print_fail() { printf "  \033[31m✗\033[0m %s\n" "$1"; }
    with_spinner() { shift; "$@" >> "$CHEZMOI_LOG_FILE" 2>&1; }
    log_silent() { :; }; log_section() { :; }
}

{{- if not .packages.go }}
exit 0
{{- end }}

set -euo pipefail

OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
ARCH="$(uname -m)"

GO_VERSION="1.25.7"
GOENV_ROOT="${HOME}/.goenv"

log_section "Go Installation"
print_header "Go ${GO_VERSION}"

# Install prerequisites based on OS
install_goenv_deps() {
    if [[ "$OS" == "darwin" ]]; then
        if ! command -v brew >/dev/null; then
            with_spinner "Installing Homebrew" /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        with_spinner "Installing git" brew install --quiet git
    elif [[ -f /etc/debian_version ]]; then
        with_spinner "Installing prerequisites" bash -c "sudo apt-get update -qq && sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq git curl"
    elif [[ -f /etc/fedora-release ]]; then
        with_spinner "Installing prerequisites" sudo dnf install -y -q git curl
    elif [[ -f /etc/centos-release ]] || [[ -f /etc/redhat-release ]] || [[ -f /etc/system-release ]]; then
        with_spinner "Installing prerequisites" sudo yum install -y -q git curl
    elif [[ -f /etc/arch-release ]]; then
        with_spinner "Installing prerequisites" sudo pacman -Sy --noconfirm --quiet git curl
    else
        print_fail "Unsupported OS for Go installation"
        exit 1
    fi
}

# Enable git HTTPS override for installation
enable_git_https_override 2>/dev/null || true

install_goenv_deps

# Install or update goenv (idempotent - updates in place)
if [[ -d "$GOENV_ROOT" ]]; then
    with_spinner "Updating goenv" bash -c "cd $GOENV_ROOT && git pull --quiet origin master"
else
    with_spinner "Installing goenv" git clone --quiet https://github.com/go-nv/goenv.git "$GOENV_ROOT"
fi

# Set up goenv environment for this script
export GOENV_ROOT
export PATH="$GOENV_ROOT/bin:$PATH"
eval "$(goenv init -)" >> "$CHEZMOI_LOG_FILE" 2>&1 || true

# Install the specified Go version (goenv handles this idempotently)
if goenv versions --bare 2>/dev/null | grep -q "^${GO_VERSION}$"; then
    with_spinner "Go ${GO_VERSION} already installed"
else
    with_spinner "Installing go ${GO_VERSION}" goenv install "$GO_VERSION"
fi

# Set global version
with_spinner "Setting go ${GO_VERSION} as global" goenv global "$GO_VERSION"
# Clean up old Go versions (keep only the current version)
log_silent "Cleaning up old Go versions"
for version in $(goenv versions --bare 2>/dev/null); do
    if [[ "$version" != "$GO_VERSION" ]]; then
        log_silent "Removing old Go version: $version"
        goenv uninstall -f "$version" >> "$CHEZMOI_LOG_FILE" 2>&1 || true
    fi
done

print_done "Go ${GO_VERSION} installed"
